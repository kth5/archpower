# POWER Maintainer: Alexander Baldeck <alex.bldck@gmail.com>
# Maintainer: Felix Yan <felixonmars@archlinux.org>

pkgname=libvips
pkgver=8.17.2
pkgrel=1
pkgdesc="A fast image processing library with low memory needs"
arch=(x86_64 powerpc64le powerpc64 powerpc espresso)
license=('LGPL-2.1-or-later')
url="https://libvips.github.io/libvips/"
depends=('cfitsio' 'fftw' 'libexif' 'libarchive' 'libimagequant' 'librsvg' 'libwebp' 'openexr'
         'highway' 'pango' 'libcgif' 'cairo' 'lcms2' 'openjpeg2')
makedepends=('gobject-introspection' 'libheif' 'libjxl' 'imagemagick' 'openslide'
             'poppler-glib' 'meson' 'gi-docgen' 'glib2-devel')
optdepends=('libheif: for heif module'
            'imagemagick: for magick module'
            'openslide: for openslide module'
            'poppler-glib: for poppler module'
            'python: for vipsprofile'
            'libjxl: for jxl module')
checkdepends=('python-pytest' 'python-pyvips')
source=("https://github.com/libvips/libvips/releases/download/v$pkgver/vips-$pkgver.tar.xz")
sha512sums=('ad35fa05ce441ab788f78e1b0b9c5db8f1e66f1295bbb78f7614560e4c37cdd0641de026b9f4cb04e7a5eaece53342dcad497f4b985d22763f5d38cbcec1bd92')

build() {
  meson build vips-$pkgver \
    --prefix=/usr \
    -Ddocs=true
  meson compile -C build
}

check() {
  case "${CARCH}" in
    powerpc|powerpc64) return 0 ;;
  esac

  export LD_LIBRARY_PATH="$srcdir/build/libvips"
  meson test -C build
  pytest -k "not test_text" -sv --log-cli-level=WARNING vips-$pkgver/test/test-suite
}

package() {
  meson install -C build --destdir="$pkgdir"
}
