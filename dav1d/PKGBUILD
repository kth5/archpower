# POWER Maintainer: Alexander Baldeck <alex.bldck@gmail.com>
# Maintainer: Levente Polyak <anthraxx[at]archlinux[dot]org>
# Maintainer: Robin Candau <antiz@archlinux.org>

pkgbase=dav1d
pkgname=('dav1d' 'dav1d-doc')
pkgver=1.5.2
pkgrel=1
pkgdesc="AV1 cross-platform decoder focused on speed and correctness"
url="https://code.videolan.org/videolan/dav1d"
arch=(x86_64 powerpc64le powerpc64 powerpc espresso)
license=('BSD-2-Clause')
makedepends=('doxygen' 'glibc' 'graphviz' 'meson' 'ninja' 'xxhash')
makedepends_x86_64=('nasm')
source=("https://downloads.videolan.org/pub/videolan/${pkgname}/${pkgver}/${pkgname}-${pkgver}.tar.xz"{,.asc}
        "https://code.videolan.org/videolan/dav1d-test-data/-/archive/${pkgver}/dav1d-test-data-${pkgver}.tar.gz")
sha512sums=('c648425994bf77d6916ec34f2b5dfa6c596138984ca186d723c5dee3d183bbe034c144088c048506582aaaf537f3b730ab1b531364c3b4a5c980f6bd3e454daf'
            'SKIP'
            '2e577eef19954845d7174dc05c1e29e58f80313f43044f8db15d171772d43bf9cf85f1f70a957a525d977f6ac803aff54cb8243f54e17c1cc4e40dcd9f9fb8b3')
b2sums=('1a7aef083622f5d0fae1d4e16c9e2cf142fd00c072fb891c4790b9166c7e9f184e5cca8718eb0eacf70e86b63a1cc9fdadb1e66bf14b42a3b291485612d3c38b'
        'SKIP'
        'a59e705ecac035862bd74500c40a9d6263b984ea5f7959cbe85041df5d666a9d0a7ccd1e2643fe4bf5261dceb78dc6016020bcd3f60532f5a076f354e270a70c')
validpgpkeys=('65F7C6B4206BD057A7EB73787180713BE58D1ADC') # VideoLAN Release Signing Key

prepare() {
	cd "${pkgbase}-${pkgver}"
	ln -s "${srcdir}/dav1d-test-data-${pkgver}" tests/dav1d-test-data
}

build() {
	cd ${pkgbase}-${pkgver}
	arch-meson \
		-Dtestdata_tests='true' \
		-Denable_docs='true' \
		build
	ninja -C build all doc/html
}

check() {
	cd "${pkgbase}-${pkgver}/build"
	meson test
}

package_dav1d() {
	depends=('glibc')
	provides=('libdav1d.so')
	optdepends=('dav1d-doc: HTML documentation')

	cd "${pkgbase}-${pkgver}"
	DESTDIR="${pkgdir}" ninja -C build install
	install -Dm 644 README.md CONTRIBUTING.md NEWS -t "${pkgdir}/usr/share/doc/${pkgname}"
	install -Dm 644 COPYING -t "${pkgdir}/usr/share/licenses/${pkgname}"
}

package_dav1d-doc() {
	pkgdesc+=" (documentation)"

	cd "${pkgbase}-${pkgver}"
	install -d "${pkgdir}/usr/share/doc/${pkgbase}"
	cp -r build/doc/html -t "${pkgdir}/usr/share/doc/${pkgbase}"
	install -Dm 644 COPYING -t "${pkgdir}/usr/share/licenses/${pkgname}"
}
