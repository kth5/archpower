# POWER Maintainer: Alexander Baldeck <alex.bldck@gmail.com>
# Maintainer: Anatol Pomozov <anatol pomozov at gmail>
# Contributor: Johannes Dewender  arch at JonnyJD dot net
# Contributor: Konrad <konrad AT knauber DOT name>
# Contributor: Luka Perkov <archlinux <at> lukaperkov <dOt> net>
# Contributor: Fernando M <f <at> beford.net>
# Author: Wintershade <Wintershade AT google mail DOT com>

# Note: rebuilds required: sogrep all librpmio.so and librpm.so

pkgname=rpm-tools
pkgver=6.0.1
pkgrel=1
pkgdesc="RPM Package Manager - RPM.org fork, used in major RPM distros"
arch=(x86_64 powerpc64le powerpc64 powerpc espresso)
url='https://rpm.org/'
license=('GPL-2.0-or-later')
depends=('lua' 'file' 'popt' 'elfutils' 'libarchive' 'libcap' 'rpm-sequoia')
makedepends=('python' 'pkg-config' 'cmake' 'scdoc')
makedepends_powerpc64le=('podman')
makedepends_riscv64=('podman')
makedepends_x86_64=('podman')
conflicts=('rpm' 'rpmextract')
options=('!libtool')
provides=("rpm=${pkgver}" 'rpmextract=1.0-4' 'rpm-org')
install=rpm-tools.install

_pkgver_major="${pkgver%%.*}"
_pkgver_major_rem="${pkgver#*.}"
_pkgver_minor="${_pkgver_major_rem%%.*}"
_base_pkgver=$_pkgver_major.$_pkgver_minor.x

source=(http://ftp.rpm.org/releases/rpm-$_base_pkgver/rpm-$pkgver.tar.bz2
        rpmextract.sh)
sha256sums=('44fd2e1425885288ce8e8da8f18e6b85bd380332c2972554a85860af10f86d0f'
            '3e5bf450d4628366ba35469ec0530a99cd09ab2616a3d261a3f68270f481f777')

prepare() {
	cd rpm-${pkgver}
}

build() {
    	cmake -B build -S "rpm-$pkgver" \
		-DCMAKE_INSTALL_PREFIX='/usr' \
		-DWITH_SELINUX=OFF \
		-DWITH_DBUS=OFF \
		-DENABLE_TESTSUITE=OFF
    	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}
